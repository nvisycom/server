name: Security

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  schedule:
    - cron: "0 1 * * *"
  workflow_dispatch:
    inputs:
      scan_type:
        description: "Type of security scan"
        required: true
        default: "full"
        type: choice
        options:
          - full
          - dependencies
          - code
          - secrets
          - containers

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  dependency-security:
    name: Dependency Security
    runs-on: ubuntu-latest
    if: >
      github.event.inputs.scan_type == 'full' ||
      github.event.inputs.scan_type == 'dependencies' ||
      github.event_name != 'workflow_dispatch'
    steps:
      - name: Checkout sources
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
          key: security-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Install security tools
        run: |
          cargo install cargo-audit
          cargo install cargo-deny

      - name: Run cargo audit
        run: |
          cargo audit --json --format json > audit-results.json
          if [ -s audit-results.json ] && [ "$(jq '.vulnerabilities | length' audit-results.json)" -gt 0 ]; then
            echo "CRITICAL: Vulnerabilities found"
            jq -r '.vulnerabilities[] | "- \(.advisory.id): \(.advisory.title) (\(.package.name) \(.package.version))"' audit-results.json
            exit 1
          fi

      - name: Run cargo deny
        run: cargo deny check

      - name: Upload results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: dependency-scan-results
          path: audit-results.json
          retention-days: 30

  code-security-analysis:
    name: Code Security Analysis
    runs-on: ubuntu-latest
    if: >
      github.event.inputs.scan_type == 'full' ||
      github.event.inputs.scan_type == 'code' ||
      github.event_name != 'workflow_dispatch'
    steps:
      - name: Checkout sources
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: code-security-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Run security-focused Clippy
        run: |
          cargo clippy --all-targets --all-features --workspace -- \
            -D clippy::unwrap_used \
            -D clippy::expect_used \
            -D clippy::panic \
            -D clippy::integer_arithmetic \
            -D clippy::indexing_slicing \
            -W clippy::suspicious \
            -W clippy::complexity

      - name: Install and run Semgrep
        run: |
          python3 -m pip install semgrep
          semgrep --config=auto --json --output=semgrep-results.json . || true

      - name: Upload results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: code-analysis-results
          path: semgrep-results.json
          retention-days: 30

  secret-detection:
    name: Secret Detection
    runs-on: ubuntu-latest
    if: >
      github.event.inputs.scan_type == 'full' ||
      github.event.inputs.scan_type == 'secrets' ||
      github.event_name != 'workflow_dispatch'
    steps:
      - name: Checkout sources
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run TruffleHog
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: main
          head: HEAD
          extra_args: --only-verified

      - name: Run Gitleaks
        run: |
          curl -sSfL https://github.com/zricethezav/gitleaks/releases/latest/download/gitleaks_8.18.4_linux_x64.tar.gz | tar -xz
          sudo mv gitleaks /usr/local/bin/
          gitleaks detect --source . --report-format json --report-path gitleaks-report.json

      - name: Check results
        run: |
          if [ -f gitleaks-report.json ] && [ "$(jq 'length' gitleaks-report.json)" -gt 0 ]; then
            echo "CRITICAL: Secrets detected"
            jq -r '.[] | "- \(.Description) in \(.File):\(.StartLine)"' gitleaks-report.json
            exit 1
          fi

      - name: Upload results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: secret-scan-results
          path: gitleaks-report.json
          retention-days: 30

  container-security:
    name: Container Security
    runs-on: ubuntu-latest
    if: >
      github.event.inputs.scan_type == 'full' ||
      github.event.inputs.scan_type == 'containers' ||
      github.event_name == 'schedule'
    steps:
      - name: Checkout sources
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build image for scanning
        uses: docker/build-push-action@v5
        with:
          context: .
          push: false
          tags: nvisy-server:scan
          load: true

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: "nvisy-server:scan"
          format: "sarif"
          output: "trivy-results.sarif"
          severity: "CRITICAL,HIGH"

      - name: Upload SARIF to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: "trivy-results.sarif"

      - name: Check for critical vulnerabilities
        run: |
          if [ -f trivy-results.sarif ]; then
            critical_count=$(jq '[.runs[0].results[] | select(.level == "error")] | length' trivy-results.sarif)
            if [ "$critical_count" -gt 0 ]; then
              echo "CRITICAL: $critical_count critical vulnerabilities found"
              exit 1
            fi
          fi

  license-compliance:
    name: License Compliance
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event.inputs.scan_type == 'full'
    steps:
      - name: Checkout sources
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Install cargo-license
        run: cargo install cargo-license

      - name: Check licenses
        run: |
          cargo license --json > licenses.json
          problematic=$(jq -r '.[] | select(.license | test("GPL|AGPL|SSPL|BCL"; "i")) | "\(.name): \(.license)"' licenses.json)
          if [ -n "$problematic" ]; then
            echo "CRITICAL: Problematic licenses found:"
            echo "$problematic"
            exit 1
          fi

      - name: Upload license report
        uses: actions/upload-artifact@v4
        with:
          name: license-report
          path: licenses.json
          retention-days: 90

  security-report:
    name: Security Report
    runs-on: ubuntu-latest
    needs: [dependency-security, code-security-analysis, secret-detection, container-security, license-compliance]
    if: always()
    steps:
      - name: Generate security report
        run: |
          cat << 'EOF' > security-report.md
          # Security Assessment Report

          **Repository**: ${{ github.repository }}
          **Branch**: ${{ github.ref_name }}
          **Commit**: ${{ github.sha }}
          **Date**: $(date -u)

          ## Results Summary

          | Domain | Status |
          |--------|--------|
          | Dependencies | ${{ needs.dependency-security.result == 'success' && 'PASS' || 'FAIL' }} |
          | Code Analysis | ${{ needs.code-security-analysis.result == 'success' && 'PASS' || 'FAIL' }} |
          | Secrets | ${{ needs.secret-detection.result == 'success' && 'PASS' || 'FAIL' }} |
          | Containers | ${{ needs.container-security.result == 'success' && 'PASS' || (needs.container-security.result == 'skipped' && 'SKIP' || 'FAIL') }} |
          | Licenses | ${{ needs.license-compliance.result == 'success' && 'PASS' || (needs.license-compliance.result == 'skipped' && 'SKIP' || 'FAIL') }} |

          ## Risk Assessment
          EOF

          # Calculate overall risk
          if [[ "${{ needs.dependency-security.result }}" == "failure" ]] || \
             [[ "${{ needs.secret-detection.result }}" == "failure" ]]; then
            echo "**Risk Level**: CRITICAL" >> security-report.md
          elif [[ "${{ needs.container-security.result }}" == "failure" ]] || \
               [[ "${{ needs.code-security-analysis.result }}" == "failure" ]]; then
            echo "**Risk Level**: HIGH" >> security-report.md
          else
            echo "**Risk Level**: LOW" >> security-report.md
          fi

          echo "" >> security-report.md
          echo "## Action Items" >> security-report.md

          if [[ "${{ needs.dependency-security.result }}" == "failure" ]]; then
            echo "- URGENT: Update vulnerable dependencies" >> security-report.md
          fi
          if [[ "${{ needs.secret-detection.result }}" == "failure" ]]; then
            echo "- URGENT: Remove/rotate detected secrets" >> security-report.md
          fi
          if [[ "${{ needs.container-security.result }}" == "failure" ]]; then
            echo "- HIGH: Address container vulnerabilities" >> security-report.md
          fi

      - name: Upload security report
        uses: actions/upload-artifact@v4
        with:
          name: security-report
          path: security-report.md
          retention-days: 90

      - name: Create security issue for critical failures
        if: >
          needs.dependency-security.result == 'failure' ||
          needs.secret-detection.result == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('security-report.md', 'utf8');

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'Critical Security Issues Detected',
              body: report,
              labels: ['security', 'critical']
            });
