name: Security

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  schedule:
    - cron: "0 1 * * *"
  workflow_dispatch:
    inputs:
      scan_type:
        description: "Type of security scan"
        required: true
        default: "full"
        type: choice
        options:
          - full
          - dependencies
          - code
          - secrets
          - containers
          - compliance

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  dependency-security:
    name: Dependency Security
    runs-on: ubuntu-latest
    if: >
      github.event.inputs.scan_type == 'full' ||
      github.event.inputs.scan_type == 'dependencies' ||
      github.event_name != 'workflow_dispatch'
    steps:
      - name: Checkout sources
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
          key: security-deps-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: security-deps-cargo-

      - name: Install security tools
        run: |
          cargo install cargo-audit
          cargo install cargo-deny
          cargo install cargo-machete

      - name: Run comprehensive dependency audit
        run: |
          # Run cargo audit with JSON output for analysis
          cargo audit --json --format json > audit-results.json || true

          # Check for vulnerabilities
          if [ -s audit-results.json ] && [ "$(jq '.vulnerabilities | length' audit-results.json 2>/dev/null || echo 0)" -gt 0 ]; then
            echo "ðŸš¨ CRITICAL: Security vulnerabilities found in dependencies"
            echo "::group::Vulnerability Details"
            jq -r '.vulnerabilities[] | "- \(.advisory.id): \(.advisory.title) (\(.package.name) \(.package.version))"' audit-results.json
            echo "::endgroup::"
            echo "vulnerability_found=true" >> $GITHUB_OUTPUT
          else
            echo "âœ… No known vulnerabilities in dependencies"
            echo "vulnerability_found=false" >> $GITHUB_OUTPUT
          fi

      - name: Run dependency policy checks
        run: |
          echo "::group::Dependency Policy Check"
          cargo deny check
          echo "::endgroup::"

      - name: Check for unused dependencies
        run: |
          echo "::group::Unused Dependencies Check"
          cargo machete
          echo "::endgroup::"

      - name: Upload dependency analysis results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: dependency-security-results
          path: audit-results.json
          retention-days: 90

  license-compliance:
    name: License Compliance
    runs-on: ubuntu-latest
    if: >
      github.event.inputs.scan_type == 'full' ||
      github.event.inputs.scan_type == 'compliance' ||
      github.event_name == 'schedule' ||
      github.event_name != 'workflow_dispatch'
    steps:
      - name: Checkout sources
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
          key: license-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: license-cargo-

      - name: Install cargo-license
        run: cargo install cargo-license

      - name: Generate license report
        run: |
          echo "::group::License Analysis"
          cargo license --json > licenses.json

          # Display all licenses for review
          echo "ðŸ“‹ All dependency licenses:"
          cargo license --tsv | sort -u
          echo "::endgroup::"

      - name: Check for problematic licenses
        run: |
          # Check for copyleft and proprietary licenses
          problematic=$(jq -r '.[] | select(.license | test("GPL|AGPL|SSPL|BCL|BUSL"; "i")) | "\(.name): \(.license)"' licenses.json)

          if [ -n "$problematic" ]; then
            echo "ðŸš¨ CRITICAL: Problematic licenses found:"
            echo "$problematic"
            echo "license_issues=true" >> $GITHUB_OUTPUT
            exit 1
          else
            echo "âœ… All licenses are compatible with MIT"
            echo "license_issues=false" >> $GITHUB_OUTPUT
          fi

      - name: Upload license report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: license-compliance-report
          path: licenses.json
          retention-days: 90

  code-security-analysis:
    name: Code Security Analysis
    runs-on: ubuntu-latest
    if: >
      github.event.inputs.scan_type == 'full' ||
      github.event.inputs.scan_type == 'code' ||
      github.event_name != 'workflow_dispatch'
    steps:
      - name: Checkout sources
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: code-security-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: code-security-cargo-

      - name: Run security-focused Clippy
        run: |
          echo "::group::Security-Focused Linting"
          cargo clippy --all-targets --all-features --workspace -- \
            -D clippy::unwrap_used \
            -D clippy::expect_used \
            -D clippy::panic \
            -D clippy::unimplemented \
            -D clippy::todo \
            -D clippy::unreachable \
            -D clippy::integer_arithmetic \
            -D clippy::indexing_slicing \
            -D clippy::as_conversions \
            -W clippy::suspicious \
            -W clippy::complexity \
            -W clippy::perf \
            -W clippy::nursery
          echo "::endgroup::"

      - name: Install and run Semgrep
        run: |
          echo "::group::Static Security Analysis (Semgrep)"
          python3 -m pip install semgrep

          # Run Semgrep with security-focused rules
          semgrep --config=security-and-quality --json --output=semgrep-results.json . || true

          # Check for high-severity issues
          high_severity=$(jq '[.results[] | select(.extra.severity == "ERROR")] | length' semgrep-results.json 2>/dev/null || echo 0)
          if [ "$high_severity" -gt 0 ]; then
            echo "âš ï¸ Found $high_severity high-severity security issues"
            jq -r '.results[] | select(.extra.severity == "ERROR") | "- \(.extra.message) (\(.path):\(.start.line))"' semgrep-results.json
          else
            echo "âœ… No high-severity security issues found"
          fi
          echo "::endgroup::"

      - name: Upload code analysis results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: code-security-results
          path: semgrep-results.json
          retention-days: 90

  secret-detection:
    name: Secret Detection
    runs-on: ubuntu-latest
    if: >
      github.event.inputs.scan_type == 'full' ||
      github.event.inputs.scan_type == 'secrets' ||
      github.event_name != 'workflow_dispatch'
    steps:
      - name: Checkout sources
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run TruffleHog
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: main
          head: HEAD
          extra_args: --only-verified --json > trufflehog-results.json || true

      - name: Run Gitleaks
        run: |
          echo "::group::Secret Detection (Gitleaks)"
          # Download and install Gitleaks
          curl -sSfL https://github.com/zricethezav/gitleaks/releases/latest/download/gitleaks_8.18.4_linux_x64.tar.gz | tar -xz
          sudo mv gitleaks /usr/local/bin/

          # Run Gitleaks scan
          gitleaks detect --source . --report-format json --report-path gitleaks-report.json --verbose || true
          echo "::endgroup::"

      - name: Analyze secret detection results
        run: |
          secrets_found=false

          # Check Gitleaks results
          if [ -f gitleaks-report.json ] && [ "$(jq 'length' gitleaks-report.json 2>/dev/null || echo 0)" -gt 0 ]; then
            echo "ðŸš¨ CRITICAL: Secrets detected by Gitleaks"
            echo "::group::Secret Details"
            jq -r '.[] | "- \(.Description) in \(.File):\(.StartLine)"' gitleaks-report.json
            echo "::endgroup::"
            secrets_found=true
          fi

          # Check TruffleHog results if available
          if [ -f trufflehog-results.json ] && [ -s trufflehog-results.json ]; then
            echo "ðŸš¨ CRITICAL: Secrets detected by TruffleHog"
            secrets_found=true
          fi

          if [ "$secrets_found" = "true" ]; then
            echo "secrets_found=true" >> $GITHUB_OUTPUT
            exit 1
          else
            echo "âœ… No secrets detected"
            echo "secrets_found=false" >> $GITHUB_OUTPUT
          fi

      - name: Upload secret detection results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: secret-detection-results
          path: |
            gitleaks-report.json
            trufflehog-results.json
          retention-days: 90

  container-security:
    name: Container Security
    runs-on: ubuntu-latest
    if: >
      github.event.inputs.scan_type == 'full' ||
      github.event.inputs.scan_type == 'containers' ||
      github.event_name == 'schedule'
    steps:
      - name: Checkout sources
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build image for scanning
        uses: docker/build-push-action@v5
        with:
          context: .
          push: false
          tags: nvisy-server:security-scan
          load: true

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: "nvisy-server:security-scan"
          format: "sarif"
          output: "trivy-results.sarif"
          severity: "CRITICAL,HIGH,MEDIUM"

      - name: Run Trivy for JSON report
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: "nvisy-server:security-scan"
          format: "json"
          output: "trivy-results.json"
          severity: "CRITICAL,HIGH,MEDIUM"

      - name: Analyze container vulnerabilities
        run: |
          if [ -f trivy-results.json ]; then
            critical_count=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity == "CRITICAL")] | length' trivy-results.json)
            high_count=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity == "HIGH")] | length' trivy-results.json)

            echo "Container vulnerability summary:"
            echo "- Critical: $critical_count"
            echo "- High: $high_count"

            if [ "$critical_count" -gt 0 ]; then
              echo "ðŸš¨ CRITICAL: $critical_count critical vulnerabilities found in container"
              echo "container_critical=true" >> $GITHUB_OUTPUT
              exit 1
            elif [ "$high_count" -gt 5 ]; then
              echo "âš ï¸ WARNING: $high_count high-severity vulnerabilities found"
              echo "container_critical=false" >> $GITHUB_OUTPUT
            else
              echo "âœ… Container security scan passed"
              echo "container_critical=false" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Upload SARIF to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: "trivy-results.sarif"

      - name: Upload container scan results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: container-security-results
          path: |
            trivy-results.json
            trivy-results.sarif
          retention-days: 90

  security-summary:
    name: Security Assessment Summary
    runs-on: ubuntu-latest
    needs: [dependency-security, license-compliance, code-security-analysis, secret-detection, container-security]
    if: always()
    steps:
      - name: Generate comprehensive security report
        id: report
        run: |
          # Calculate overall security posture
          critical_issues=0
          high_issues=0

          # Check for critical failures
          if [[ "${{ needs.dependency-security.result }}" == "failure" ]]; then
            echo "ðŸš¨ CRITICAL: Dependency vulnerabilities detected"
            critical_issues=$((critical_issues + 1))
          fi

          if [[ "${{ needs.secret-detection.result }}" == "failure" ]]; then
            echo "ðŸš¨ CRITICAL: Secrets detected in repository"
            critical_issues=$((critical_issues + 1))
          fi

          if [[ "${{ needs.license-compliance.result }}" == "failure" ]]; then
            echo "ðŸš¨ CRITICAL: License compliance issues"
            critical_issues=$((critical_issues + 1))
          fi

          if [[ "${{ needs.container-security.result }}" == "failure" ]]; then
            echo "âš ï¸ HIGH: Container security vulnerabilities"
            high_issues=$((high_issues + 1))
          fi

          if [[ "${{ needs.code-security-analysis.result }}" == "failure" ]]; then
            echo "âš ï¸ HIGH: Code security analysis issues"
            high_issues=$((high_issues + 1))
          fi

          # Determine overall risk level
          if [ $critical_issues -gt 0 ]; then
            risk_level="CRITICAL"
            status="âŒ FAILED"
          elif [ $high_issues -gt 0 ]; then
            risk_level="HIGH"
            status="âš ï¸ WARNING"
          else
            risk_level="LOW"
            status="âœ… PASSED"
          fi

          echo "risk_level=$risk_level" >> $GITHUB_OUTPUT
          echo "critical_issues=$critical_issues" >> $GITHUB_OUTPUT
          echo "high_issues=$high_issues" >> $GITHUB_OUTPUT

          # Create detailed security report
          cat << EOF > security-assessment.md
          # ðŸ”’ Security Assessment Report

          **Repository**: ${{ github.repository }}
          **Branch**: ${{ github.ref_name }}
          **Commit**: ${{ github.sha }}
          **Date**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          **Overall Status**: $status
          **Risk Level**: $risk_level

          ## ðŸ“Š Results Summary

          | Security Domain | Status | Details |
          |----------------|--------|---------|
          | Dependencies | ${{ needs.dependency-security.result == 'success' && 'âœ… PASS' || 'âŒ FAIL' }} | Vulnerability and policy checks |
          | License Compliance | ${{ needs.license-compliance.result == 'success' && 'âœ… PASS' || (needs.license-compliance.result == 'skipped' && 'â­ï¸ SKIP' || 'âŒ FAIL') }} | License compatibility analysis |
          | Code Security | ${{ needs.code-security-analysis.result == 'success' && 'âœ… PASS' || (needs.code-security-analysis.result == 'skipped' && 'â­ï¸ SKIP' || 'âŒ FAIL') }} | Static security analysis |
          | Secret Detection | ${{ needs.secret-detection.result == 'success' && 'âœ… PASS' || (needs.secret-detection.result == 'skipped' && 'â­ï¸ SKIP' || 'âŒ FAIL') }} | Repository secret scanning |
          | Container Security | ${{ needs.container-security.result == 'success' && 'âœ… PASS' || (needs.container-security.result == 'skipped' && 'â­ï¸ SKIP' || 'âŒ FAIL') }} | Docker image vulnerability scan |

          ## ðŸŽ¯ Action Items
          EOF

          if [ $critical_issues -gt 0 ]; then
            echo "" >> security-assessment.md
            echo "### ðŸš¨ URGENT (Critical Priority)" >> security-assessment.md
          fi

          if [[ "${{ needs.dependency-security.result }}" == "failure" ]]; then
            echo "- Update or patch vulnerable dependencies immediately" >> security-assessment.md
          fi

          if [[ "${{ needs.secret-detection.result }}" == "failure" ]]; then
            echo "- Immediately revoke/rotate any detected secrets" >> security-assessment.md
            echo "- Remove secrets from git history if necessary" >> security-assessment.md
          fi

          if [[ "${{ needs.license-compliance.result }}" == "failure" ]]; then
            echo "- Review and replace dependencies with problematic licenses" >> security-assessment.md
          fi

          if [ $high_issues -gt 0 ]; then
            echo "" >> security-assessment.md
            echo "### âš ï¸ Important (High Priority)" >> security-assessment.md
          fi

          if [[ "${{ needs.container-security.result }}" == "failure" ]]; then
            echo "- Update base images and dependencies in Dockerfile" >> security-assessment.md
          fi

          if [[ "${{ needs.code-security-analysis.result }}" == "failure" ]]; then
            echo "- Address security-related code issues identified by static analysis" >> security-assessment.md
          fi

          if [ $critical_issues -eq 0 ] && [ $high_issues -eq 0 ]; then
            echo "" >> security-assessment.md
            echo "âœ… **No critical security issues detected. Good job!**" >> security-assessment.md
            echo "" >> security-assessment.md
            echo "Continue following security best practices and keep dependencies updated." >> security-assessment.md
          fi

      - name: Upload security assessment
        uses: actions/upload-artifact@v4
        with:
          name: security-assessment-report
          path: security-assessment.md
          retention-days: 180

      - name: Create security summary
        run: |
          echo "# ðŸ”’ Security Assessment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          cat security-assessment.md >> $GITHUB_STEP_SUMMARY

      - name: Create security issue for critical failures
        if: steps.report.outputs.critical_issues > 0
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('security-assessment.md', 'utf8');

            // Check if an existing security issue is open
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'security,critical',
              state: 'open'
            });

            if (issues.data.length === 0) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'ðŸš¨ Critical Security Issues Detected',
                body: report + '\n\n---\n*This issue was automatically created by the Security workflow.*',
                labels: ['security', 'critical', 'automated']
              });
            } else {
              // Update existing issue
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issues.data[0].number,
                body: '## ðŸ”„ Security Assessment Update\n\n' + report
              });
            }

      - name: Fail workflow on critical security issues
        if: steps.report.outputs.critical_issues > 0
        run: |
          echo "ðŸ’¥ Workflow failed due to ${{ steps.report.outputs.critical_issues }} critical security issue(s)"
          exit 1
