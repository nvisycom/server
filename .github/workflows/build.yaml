name: Build & Test

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  schedule:
    # Run daily at 2 AM UTC to catch dependency issues
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      full_test_matrix:
        description: 'Run full test matrix (all OS/Rust versions)'
        required: false
        default: false
        type: boolean
      performance_tests:
        description: 'Run performance regression tests'
        required: false
        default: false
        type: boolean

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1
  CARGO_INCREMENTAL: 0
  CARGO_NET_RETRY: 10
  RUSTUP_MAX_RETRIES: 10

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  check:
    name: Code Quality Checks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout sources
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Set up cargo cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Check code formatting
        run: cargo fmt --all -- --check

      - name: Run cargo check
        run: cargo check --all-targets --all-features --workspace

      - name: Run clippy
        run: |
          cargo clippy --all-targets --all-features --workspace -- \
            -D warnings \
            -D clippy::all \
            -D clippy::suspicious \
            -D clippy::complexity \
            -W clippy::perf \
            -W clippy::style

      - name: Check documentation
        run: cargo doc --no-deps --all-features --workspace --document-private-items
        env:
          RUSTDOCFLAGS: -D warnings

  test:
    name: Test Suite
    runs-on: ${{ matrix.os }}
    needs: check
    strategy:
      fail-fast: false
      matrix:
        os: ${{ github.event.inputs.full_test_matrix == 'true' && fromJson('["ubuntu-latest", "windows-latest", "macos-latest"]') || fromJson('["ubuntu-latest"]') }}
        rust: ${{ github.event.inputs.full_test_matrix == 'true' && fromJson('["stable", "beta"]') || fromJson('["stable"]') }}
        exclude:
          - os: windows-latest
            rust: beta
          - os: macos-latest
            rust: beta

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_USER: postgres
          POSTGRES_DB: nvisy_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
      - name: Checkout sources
        uses: actions/checkout@v4

      - name: Install ${{ matrix.rust }} Rust toolchain
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ matrix.rust }}

      - name: Set up cargo cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-${{ matrix.rust }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-${{ matrix.rust }}-cargo-
            ${{ runner.os }}-cargo-

      - name: Install system dependencies (Ubuntu)
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y libpq-dev

      - name: Install Diesel CLI
        if: matrix.os == 'ubuntu-latest'
        run: cargo install diesel_cli --no-default-features --features postgres
        env:
          CARGO_NET_RETRY: 10

      - name: Setup test database
        if: matrix.os == 'ubuntu-latest'
        run: diesel database setup
        env:
          DATABASE_URL: postgres://postgres:postgres@localhost/nvisy_test

      - name: Run tests with database
        if: matrix.os == 'ubuntu-latest'
        run: cargo test --all-features --workspace
        env:
          DATABASE_URL: postgres://postgres:postgres@localhost/nvisy_test
          REDIS_URL: redis://localhost:6379

      - name: Run tests without database
        if: matrix.os != 'ubuntu-latest'
        run: cargo test --all-features --workspace --exclude nvisy-postgres

  coverage:
    name: Code Coverage
    runs-on: ubuntu-latest
    needs: check
    if: github.event_name == 'push' || github.event_name == 'pull_request'

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_USER: postgres
          POSTGRES_DB: nvisy_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
      - name: Checkout sources
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: llvm-tools-preview

      - name: Set up cargo cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: coverage-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: coverage-cargo-

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libpq-dev

      - name: Install coverage tools
        run: |
          cargo install cargo-llvm-cov
          cargo install diesel_cli --no-default-features --features postgres

      - name: Setup test database
        run: diesel database setup
        env:
          DATABASE_URL: postgres://postgres:postgres@localhost/nvisy_test

      - name: Generate code coverage
        run: cargo llvm-cov --all-features --workspace --lcov --output-path lcov.info
        env:
          DATABASE_URL: postgres://postgres:postgres@localhost/nvisy_test
          REDIS_URL: redis://localhost:6379

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: lcov.info
          fail_ci_if_error: false
          flags: unittests
          name: codecov-umbrella

  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout sources
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Set up cargo cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
          key: audit-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: audit-cargo-

      - name: Install security tools
        run: |
          cargo install cargo-audit
          cargo install cargo-deny

      - name: Run cargo audit
        run: cargo audit --deny warnings

      - name: Run cargo deny
        run: cargo deny check

      - name: Check for unused dependencies
        run: |
          cargo install cargo-machete
          cargo machete

  performance:
    name: Performance Tests
    runs-on: ubuntu-latest
    if: github.event.inputs.performance_tests == 'true' || github.event_name == 'schedule'
    needs: check

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_USER: postgres
          POSTGRES_DB: nvisy_perf
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: Checkout sources
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Set up cargo cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: perf-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: perf-cargo-

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libpq-dev

      - name: Install performance tools
        run: |
          cargo install diesel_cli --no-default-features --features postgres
          cargo install cargo-criterion

      - name: Setup performance database
        run: diesel database setup
        env:
          DATABASE_URL: postgres://postgres:postgres@localhost/nvisy_perf

      - name: Run benchmarks
        run: cargo criterion --output-format json > benchmark-results.json
        env:
          DATABASE_URL: postgres://postgres:postgres@localhost/nvisy_perf

      - name: Store benchmark results
        uses: benchmark-action/github-action-benchmark@v1
        with:
          tool: 'cargo'
          output-file-path: benchmark-results.json
          github-token: ${{ secrets.GITHUB_TOKEN }}
          auto-push: true
          comment-on-alert: true
          alert-threshold: '150%'
          fail-on-alert: false

      - name: Upload performance results
        uses: actions/upload-artifact@v4
        with:
          name: performance-results
          path: benchmark-results.json
          retention-days: 30

  docs:
    name: Documentation
    runs-on: ubuntu-latest
    needs: check
    if: github.ref == 'refs/heads/main' || github.event_name == 'pull_request'
    steps:
      - name: Checkout sources
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Set up cargo cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: docs-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: docs-cargo-

      - name: Generate documentation
        run: |
          cargo doc --no-deps --all-features --workspace --document-private-items
          echo '<meta http-equiv=refresh content=0;url=nvisy_server/index.html>' > target/doc/index.html

      - name: Deploy documentation
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./target/doc
          destination_dir: api-docs

  license-check:
    name: License Compliance
    runs-on: ubuntu-latest
    steps:
      - name: Checkout sources
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Install cargo-license
        run: cargo install cargo-license

      - name: Check licenses
        run: |
          cargo license --json > licenses.json

          # Check for problematic licenses
          if jq -e '.[] | select(.license | test("GPL|AGPL|SSPL|BCL"; "i"))' licenses.json > /dev/null; then
            echo "âŒ Problematic licenses found:"
            jq -r '.[] | select(.license | test("GPL|AGPL|SSPL|BCL"; "i")) | "\(.name): \(.license)"' licenses.json
            exit 1
          else
            echo "âœ… All licenses are compatible"
          fi

      - name: Upload license report
        uses: actions/upload-artifact@v4
        with:
          name: license-report
          path: licenses.json
          retention-days: 30

  build-summary:
    name: Build Summary
    runs-on: ubuntu-latest
    needs: [check, test, coverage, security-audit, performance, docs, license-check]
    if: always()
    steps:
      - name: Create build summary
        run: |
          echo "# Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Code Quality | ${{ needs.check.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Tests | ${{ needs.test.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Coverage | ${{ needs.coverage.result == 'success' && 'âœ…' || (needs.coverage.result == 'skipped' && 'â­ï¸' || 'âŒ') }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security Audit | ${{ needs.security-audit.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Performance | ${{ needs.performance.result == 'success' && 'âœ…' || (needs.performance.result == 'skipped' && 'â­ï¸' || 'âŒ') }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Documentation | ${{ needs.docs.result == 'success' && 'âœ…' || (needs.docs.result == 'skipped' && 'â­ï¸' || 'âŒ') }} |" >> $GITHUB_STEP_SUMMARY
          echo "| License Check | ${{ needs.license-check.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ needs.check.result }}" == "success" &&
                "${{ needs.test.result }}" == "success" &&
                "${{ needs.security-audit.result }}" == "success" &&
                "${{ needs.license-check.result }}" == "success" ]]; then
            echo "ðŸŽ‰ **All critical checks passed!**" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Some checks failed. Please review and fix.**" >> $GITHUB_STEP_SUMMARY
          fi
